zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: f10fc491a20f4d0983147fe4c6d7c361
      name: Templates
  templates:
    - uuid: bfba2694a1484090959c015edf4dc876
      template: 'Systemd by Zabbix agent 2'
      name: 'Systemd by Zabbix agent 2'
      description: |
        Get systemd units metrics from plugin for the zabbix-agent2.
          1. Setup and configure zabbix-agent2 compiled with the Systemd monitoring plugin.
          2. Set filters with macros if you want to override default filter parameters.
        
        You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/
        
        Generated by official Zabbix template tool "Templator"
      groups:
        - name: Templates
      discovery_rules:
        - uuid: 4ff0e36e473c40e1a14faa3197b40758
          name: 'Service units discovery'
          key: 'systemd.unit.discovery[service]'
          delay: 30m
          filter:
            evaltype: AND
            conditions:
              - macro: '{#UNIT.ACTIVESTATE}'
                value: '{$SYSTEMD.ACTIVESTATE.SERVICE.MATCHES}'
              - macro: '{#UNIT.ACTIVESTATE}'
                value: '{$SYSTEMD.ACTIVESTATE.SERVICE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#UNIT.NAME}'
                value: '{$SYSTEMD.NAME.SERVICE.MATCHES}'
              - macro: '{#UNIT.NAME}'
                value: '{$SYSTEMD.NAME.SERVICE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#UNIT.SERVICETYPE}'
                value: '{$SYSTEMD.SERVICETYPE.SERVICE.MATCHES}'
              - macro: '{#UNIT.SERVICETYPE}'
                value: '{$SYSTEMD.SERVICETYPE.SERVICE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#UNIT.UNITFILESTATE}'
                value: '{$SYSTEMD.UNITFILESTATE.SERVICE.MATCHES}'
              - macro: '{#UNIT.UNITFILESTATE}'
                value: '{$SYSTEMD.UNITFILESTATE.SERVICE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discover systemd service units and their details.'
          item_prototypes:
            - uuid: 6889006b43a545f29d73d619bb3a718f
              name: '{#UNIT.NAME}: Active state'
              type: DEPENDENT
              key: 'systemd.service.active_state["{#UNIT.NAME}"]'
              description: 'State value that reflects whether the unit is currently active or not. The following states are currently defined: "active", "reloading", "inactive", "failed", "activating", and "deactivating".'
              valuemap:
                name: 'Unit Active State'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.ActiveState.state
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 30m
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}"]'
              tags:
                - tag: component
                  value: service
              trigger_prototypes:
                - uuid: 8916290c68ce470fbb7225fc27817bf0
                  expression: 'last(/Systemd by Zabbix agent 2/systemd.service.active_state["{#UNIT.NAME}"])<>1'
                  name: 'Systemd: {#UNIT.NAME}: Service is not running'
                  priority: WARNING
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: availability
            - uuid: 809d5e56d8e3423986fd4e8df949e488
              name: '{#UNIT.NAME}: Load state'
              type: DEPENDENT
              key: 'systemd.service.load_state["{#UNIT.NAME}"]'
              description: 'State value that reflects whether the configuration file of this unit has been loaded. The following states are currently defined: "loaded", "error", and "masked".'
              valuemap:
                name: 'Unit Load State'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.LoadState.state
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 30m
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}"]'
              tags:
                - tag: component
                  value: service
            - uuid: b11606ecc4d940469c7bd8fa550908a1
              name: '{#UNIT.NAME}: Unit file state'
              type: DEPENDENT
              key: 'systemd.service.unitfile_state["{#UNIT.NAME}"]'
              description: 'Encodes the install state of the unit file of FragmentPath. It currently knows the following states: "enabled", "enabled-runtime", "linked", "linked-runtime", "masked", "masked-runtime", "static", "disabled", and "invalid".'
              valuemap:
                name: 'Unit File State'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.UnitFileState.state
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 30m
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}"]'
              tags:
                - tag: component
                  value: service
            - uuid: 6b918a350fe04475bb071a7d28f0ab70
              name: '{#UNIT.NAME}: Active time'
              type: DEPENDENT
              key: 'systemd.service.uptime["{#UNIT.NAME}"]'
              value_type: FLOAT
              units: uptime
              description: 'Number of seconds since unit entered the active state.'
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      data = JSON.parse(value);
                      if (data.ActiveEnterTimestamp > data.ActiveExitTimestamp) {
                        return Math.floor(Date.now() / 1000) - Number(data.ActiveEnterTimestamp) / 1000000;
                      }
                      return null;
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}"]'
              tags:
                - tag: component
                  value: service
              trigger_prototypes:
                - uuid: a0ef985761a64704813fd459b7555931
                  expression: 'last(/Systemd by Zabbix agent 2/systemd.service.uptime["{#UNIT.NAME}"])<10m'
                  name: 'Systemd: {#UNIT.NAME} has been restarted'
                  event_name: 'Systemd: {#UNIT.NAME} has been restarted (uptime < 10m)'
                  priority: INFO
                  description: 'Uptime is less than 10 minutes.'
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: notice
            - uuid: f6c4f351804544ed984a0f922315417f
              name: '{#UNIT.NAME}: Get unit info'
              key: 'systemd.unit.get["{#UNIT.NAME}"]'
              history: '0'
              value_type: TEXT
              description: |
                Returns all properties of a systemd service unit.
                 Unit description: {#UNIT.DESCRIPTION}.
              tags:
                - tag: component
                  value: raw
                - tag: component
                  value: unit
        - uuid: 72ee4cf53e36444b9d8357dd55833abb
          name: 'Socket units discovery'
          key: 'systemd.unit.discovery[socket]'
          delay: 30m
          filter:
            evaltype: AND
            conditions:
              - macro: '{#UNIT.ACTIVESTATE}'
                value: '{$SYSTEMD.ACTIVESTATE.SOCKET.MATCHES}'
              - macro: '{#UNIT.ACTIVESTATE}'
                value: '{$SYSTEMD.ACTIVESTATE.SOCKET.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#UNIT.NAME}'
                value: '{$SYSTEMD.NAME.SOCKET.MATCHES}'
              - macro: '{#UNIT.NAME}'
                value: '{$SYSTEMD.NAME.SOCKET.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#UNIT.UNITFILESTATE}'
                value: '{$SYSTEMD.UNITFILESTATE.SOCKET.MATCHES}'
              - macro: '{#UNIT.UNITFILESTATE}'
                value: '{$SYSTEMD.UNITFILESTATE.SOCKET.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discover systemd socket units and their details.'
          item_prototypes:
            - uuid: 70ce6e6b366e4b6d9f9d55e632c390b7
              name: '{#UNIT.NAME}: Connections accepted per sec'
              type: DEPENDENT
              key: 'systemd.socket.conn_accepted.rate["{#UNIT.NAME}"]'
              description: 'The number of accepted socket connections (NAccepted) per second.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.NAccepted
                - type: CHANGE_PER_SECOND
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}",Socket]'
              tags:
                - tag: component
                  value: socket
            - uuid: 191045a9b62d4bf78c6eb36fae5cf0b6
              name: '{#UNIT.NAME}: Connections connected'
              type: DEPENDENT
              key: 'systemd.socket.conn_count["{#UNIT.NAME}"]'
              description: 'The current number of socket connections (NConnections).'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.NConnections
              master_item:
                key: 'systemd.unit.get["{#UNIT.NAME}",Socket]'
              tags:
                - tag: component
                  value: socket
            - uuid: d3d19f5d7b5945998a736723fe077ef9
              name: '{#UNIT.NAME}: Get unit info'
              key: 'systemd.unit.get["{#UNIT.NAME}",Socket]'
              history: '0'
              value_type: TEXT
              description: |
                Returns all properties of a systemd socket unit.
                 Unit description: {#UNIT.DESCRIPTION}.
              tags:
                - tag: component
                  value: raw
                - tag: component
                  value: socket
      tags:
        - tag: class
          value: software
        - tag: target
          value: systemd
      macros:
        - macro: '{$SYSTEMD.ACTIVESTATE.SERVICE.MATCHES}'
          value: .+
          description: 'Filter of systemd service units by active state.'
        - macro: '{$SYSTEMD.ACTIVESTATE.SERVICE.NOT_MATCHES}'
          value: ^inactive$
          description: 'Filter of systemd service units by active state.'
        - macro: '{$SYSTEMD.ACTIVESTATE.SOCKET.MATCHES}'
          value: .+
          description: 'Filter of systemd socket units by active state.'
        - macro: '{$SYSTEMD.ACTIVESTATE.SOCKET.NOT_MATCHES}'
          value: ^inactive$
          description: 'Filter of systemd socket units by active state.'
        - macro: '{$SYSTEMD.NAME.SERVICE.MATCHES}'
          value: .+
          description: 'Filter of systemd service units by name.'
        - macro: '{$SYSTEMD.NAME.SERVICE.NOT_MATCHES}'
          value: '^(?:ifupdown-wait-online.+|systemd-networkd-wait-online.+|networking.+|container-getty.+)$'
          description: 'Filter of systemd service units by name.'
        - macro: '{$SYSTEMD.NAME.SOCKET.MATCHES}'
          value: .+
          description: 'Filter of systemd socket units by name.'
        - macro: '{$SYSTEMD.NAME.SOCKET.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter of systemd socket units by name.'
        - macro: '{$SYSTEMD.SERVICETYPE.SERVICE.MATCHES}'
          value: .+
          description: 'Filter of systemd service units by service type.'
        - macro: '{$SYSTEMD.SERVICETYPE.SERVICE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter of systemd service units by service type.'
        - macro: '{$SYSTEMD.UNITFILESTATE.SERVICE.MATCHES}'
          value: ^enabled$
          description: 'Filter of systemd service units by unit file state.'
        - macro: '{$SYSTEMD.UNITFILESTATE.SERVICE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter of systemd service units by unit file state.'
        - macro: '{$SYSTEMD.UNITFILESTATE.SOCKET.MATCHES}'
          value: ^enabled$
          description: 'Filter of systemd socket units by unit file state.'
        - macro: '{$SYSTEMD.UNITFILESTATE.SOCKET.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'Filter of systemd socket units by unit file state.'
      dashboards:
        - uuid: 5631dafd939a4cc4a5c2dba3859c3bec
          name: 'Systemd: Overview'
          pages:
            - name: Services
              widgets:
                - type: graphprototype
                  width: '72'
                  height: '20'
                  fields:
                    - type: ITEM_PROTOTYPE
                      name: itemid.0
                      value:
                        host: 'Systemd by Zabbix agent 2'
                        key: 'systemd.service.active_state["{#UNIT.NAME}"]'
                    - type: STRING
                      name: reference
                      value: AAAAA
                    - type: INTEGER
                      name: rows
                      value: '5'
                    - type: INTEGER
                      name: source_type
                      value: '3'
            - name: Sockets
              widgets:
                - type: graphprototype
                  width: '72'
                  height: '20'
                  fields:
                    - type: ITEM_PROTOTYPE
                      name: itemid.0
                      value:
                        host: 'Systemd by Zabbix agent 2'
                        key: 'systemd.socket.conn_count["{#UNIT.NAME}"]'
                    - type: STRING
                      name: reference
                      value: AAAAB
                    - type: INTEGER
                      name: rows
                      value: '5'
                    - type: INTEGER
                      name: source_type
                      value: '3'
      valuemaps:
        - uuid: 44c74299ba71451c910fe9b2119a7bd6
          name: 'Unit Active State'
          mappings:
            - value: '0'
              newvalue: unknown
            - value: '1'
              newvalue: active
            - value: '2'
              newvalue: reloading
            - value: '3'
              newvalue: inactive
            - value: '4'
              newvalue: failed
            - value: '5'
              newvalue: activating
            - value: '6'
              newvalue: deactivating
        - uuid: d2baa072d4ea477eb8648537a88a5e55
          name: 'Unit File State'
          mappings:
            - value: '0'
              newvalue: unknown
            - value: '1'
              newvalue: enabled
            - value: '2'
              newvalue: enabled-runtime
            - value: '3'
              newvalue: linked
            - value: '4'
              newvalue: linked-runtime
            - value: '5'
              newvalue: masked
            - value: '6'
              newvalue: masked-runtime
            - value: '7'
              newvalue: static
            - value: '8'
              newvalue: disabled
            - value: '9'
              newvalue: invalid
        - uuid: 101798463e0746ce8fe5564dc021d9e7
          name: 'Unit Load State'
          mappings:
            - value: '0'
              newvalue: unknown
            - value: '1'
              newvalue: loaded
            - value: '2'
              newvalue: error
            - value: '3'
              newvalue: masked
