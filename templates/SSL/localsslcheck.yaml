zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: Templates
  templates:
    - uuid: 979a8c9d77ea4264979dbff00f779ed7
      template: 'Local SSL Check'
      name: 'Local SSL Check'
      description: 'Check SSL certificate validity using OpenSSL against a local file'
      vendor:
        name: astsu777
        version: 1.0.0
      groups:
        - name: Templates
      items:
        - uuid: 1ecbb02dde154271b3bc98a7a5cf5a87
          name: Validation
          key: 'system.run[openssl x509 -noout -checkend 1 -in {$CERT_FILE} | printf "%s" "$?"]'
          trends: '0'
          description: |
            0 = certificate is valid
            1 = certificate will expire in 1 day
          tags:
            - tag: Application
              value: OpenSSL
          triggers:
            - uuid: 20c1ced881c24c8e8761e72cb3eada76
              expression: 'last(/Local SSL Check/system.run[openssl x509 -noout -checkend 1 -in {$CERT_FILE} | printf "%s" "$?"],#1)<>0'
              name: 'Certificate: SSL certificate is expired'
              event_name: 'Certificate: SSL certificate is expired'
              priority: DISASTER
              description: 'The SSL certificate is expired and needs to be renewed'
        - uuid: 6344e0aa6e0e4869b164b66242b9ce81
          name: 'End Date'
          key: 'system.run[openssl x509 -noout -enddate -in {$CERT_FILE} | cut -d= -f2- | date +%s -f -]'
          units: unixtime
          description: 'Date of expiration'
          tags:
            - tag: Application
              value: OpenSSL
          triggers:
            - uuid: ecc0b56926924c6aabb442803d94baf3
              expression: '(last(/Local SSL Check/system.run[openssl x509 -noout -enddate -in {$CERT_FILE} | cut -d= -f2- | date +%s -f -]) - now()) / 86400 < {$CERT.EXPIRY.WARN}'
              name: 'Certificate: SSL certificate expires soon'
              event_name: 'Certificate: SSL certificate expires soon (less than {$CERT.EXPIRY.WARN} days)'
              priority: WARNING
              description: 'The SSL certificate should be updated or it will become untrusted.'
            - uuid: 695d7ac0656f47a183abacc7d539a39e
              expression: '(last(/Local SSL Check/system.run[openssl x509 -noout -enddate -in {$CERT_FILE} | cut -d= -f2- | date +%s -f -]) - now()) / 86400 < {$CERT.EXPIRY.HIGH}'
              name: 'Certificate: SSL certificate expires very soon'
              event_name: 'Certificate: SSL certificate expires very soon (less than {$CERT.EXPIRY.WARN} days)'
              priority: AVERAGE
              description: 'The SSL certificate should be updated or it will become untrusted.'
            - uuid: 9e12ed10481846f29c70f55b7e844bef
              expression: '(last(/Local SSL Check/system.run[openssl x509 -noout -enddate -in {$CERT_FILE} | cut -d= -f2- | date +%s -f -]) - now()) / 86400 < {$CERT.EXPIRY.NOW}'
              name: 'Certificate: SSL certificate will expire'
              event_name: 'Certificate: SSL certificate expires soon (less than {$CERT.EXPIRY.NOW} day)'
              priority: HIGH
              description: 'The SSL certificate should be updated or it will become untrusted.'
        - uuid: 3990b3f38e1a4663b98d71208e7f68e5
          name: Fingerprint
          key: 'system.run[openssl x509 -noout -fingerprint -in {$CERT_FILE} | cut -d= -f2-]'
          value_type: TEXT
          description: 'Unique digital identifier'
          tags:
            - tag: Application
              value: OpenSSL
          triggers:
            - uuid: 9f723aef376148d69cf5385c033eb3ad
              expression: 'last(/Local SSL Check/system.run[openssl x509 -noout -fingerprint -in {$CERT_FILE} | cut -d= -f2-]) <> last(/Local SSL Check/system.run[openssl x509 -noout -fingerprint -in {$CERT_FILE} | cut -d= -f2-],#2)'
              name: 'Certificate: Fingerprint has changed'
              event_name: 'Certificate: Fingerprint has changed (new version: {ITEM.VALUE})'
              priority: INFO
              description: |
                The SSL certificate fingerprint has changed. If you did not update the certificate, it may mean your certificate has been hacked. Acknowledge to close the problem manually.
                There could be multiple valid certificates on some installations. In this case, the trigger will have a false positive. You can ignore it or disable the trigger.
              manual_close: 'YES'
        - uuid: 2dbd193d2b7a448399617c133d663d5a
          name: 'Start Date'
          key: 'system.run[openssl x509 -noout -startdate -in {$CERT_FILE} | cut -d= -f2- | date +%s -f -]'
          units: unixtime
          description: 'Validity start date'
          tags:
            - tag: Application
              value: OpenSSL
        - uuid: c2bb256488d14508a504a8439aaba298
          name: Subject
          key: 'system.run[openssl x509 -noout -subject -in {$CERT_FILE} | cut -d= -f2-]'
          value_type: TEXT
          description: 'Entity''s identity'
          tags:
            - tag: Application
              value: OpenSSL
      tags:
        - tag: class
          value: software
        - tag: target
          value: openssl
      macros:
        - macro: '{$CERT.EXPIRY.HIGH}'
          value: '14'
          description: 'Number of days until certificate expires'
        - macro: '{$CERT.EXPIRY.NOW}'
          value: '1'
          description: 'Number of days until certificate expires'
        - macro: '{$CERT.EXPIRY.WARN}'
          value: '28'
          description: 'Number of days until certificate expires'
        - macro: '{$CERT_FILE}'
          description: 'Absolute path to the certificate file'
